<?xml version="1.0" encoding="utf-8"?>
<DayEntry xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="urn:newtelligence-com:dasblog:runtime:data">
  <Date>2007-09-16T02:00:00+02:00</Date>
  <Entries>
    <Entry>
      <Content>&lt;p&gt;Wow, what a mouthful of a title.&lt;/p&gt; &lt;p&gt;What do we have here? We've got a Site-To-Site VPN to be established from a ISA Server with a dynamic IP address.&amp;nbsp;Dynamic&amp;nbsp;IP&amp;nbsp;addresses are assigned by &lt;abbr title="Internet Service Provider"&gt;ISP&lt;/abbr&gt;s for consumer cable and DSL&amp;nbsp;internet connections and will be renewed at least each 24 hours. That is, every time&amp;nbsp;your internet connection is established, your public IP changes. This prevents you from&amp;nbsp;hosting&amp;nbsp;internet servers&amp;nbsp;on top of your&amp;nbsp;cheapo DSL service.&lt;/p&gt; &lt;p&gt;Site-To-Site VPNs basically connect two private networks over a secured internet tunnel. ISA Server supports Site-To-Site VPNs but requires a &lt;em&gt;static&lt;/em&gt; IP address for the local VPN gateway. Since the local VPN gateway&amp;nbsp;is your ISA Server that has a&amp;nbsp;&lt;em&gt;dynamic&lt;/em&gt; IP address, you have to either purchase a static IP address&amp;nbsp;(expensive) or update the local endpoint's IP address every time your internet connection is established. A pitfall I ran into when I was setting up the VPN connection together with my very helpful colleague Timo from &lt;a href="http://www.synexus.de/"&gt;Synexus&lt;/a&gt;&amp;nbsp;was that we were able to successfully connect to the remote site&amp;nbsp;until&amp;nbsp;the DSL connection dropped. All further VPN connection attempts&amp;nbsp;failed because due to the reconnect, ISA Server's public IP changed.&amp;nbsp;This isn't reflected by the remote site configuration, the dropdown box is just emptied:&lt;/p&gt; &lt;p style="text-align: center"&gt;&lt;img alt="Local Endpoint IP is empty after reconnects" src="http://www.therightstuff.de/content/binary/WindowsLiveWriter/UpdatingISAServersLocalIPSecEndpointAddr_118F4/Local%20Endpoint%20IP%20Empty_b7ea4043-4622-4816-8375-25dbcfdeab2b.gif" border="0"&gt; &lt;/p&gt; &lt;p&gt;Now you'll either have to change the local endpoint address using the&amp;nbsp;ISA Server management console&amp;nbsp;&lt;em&gt;every time&lt;/em&gt; your DSL line is connected or you could automate&amp;nbsp;that using &lt;a title="ISA Server Documentation on MSDN" href="http://msdn2.microsoft.com/en-us/library/aa503251.aspx"&gt;ISA's rich COM object model&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;Scripting the ISA Server COM objects with &lt;a href="http://www.microsoft.com/windowsserver2003/technologies/management/powershell/default.mspx"&gt;Windows PowerShell&lt;/a&gt; is easy. It actually takes just&amp;nbsp;six lines of code to set the new public IP for all Site-To-Site VPN connections.&lt;/p&gt;&lt;pre&gt;&lt;span style="color: #0000ff"&gt;param&lt;/span&gt;&lt;span style="color: #000000"&gt;([string] &lt;/span&gt;&lt;span style="color: #800080"&gt;$newIP&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;$&lt;/span&gt;&lt;span style="color: #000000"&gt;(&lt;/span&gt;&lt;span style="color: #0000ff"&gt;throw&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #800000"&gt;"&lt;/span&gt;&lt;span style="color: #800000"&gt;Update-IsaServerIPSecPublicIp: New IP address is missing&lt;/span&gt;&lt;span style="color: #800000"&gt;"&lt;/span&gt;&lt;span style="color: #000000"&gt;))

&lt;/span&gt;&lt;span style="color: #800080"&gt;$root&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; New&lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;Object &lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;comObject &lt;/span&gt;&lt;span style="color: #800000"&gt;"&lt;/span&gt;&lt;span style="color: #800000"&gt;FPC.Root&lt;/span&gt;&lt;span style="color: #800000"&gt;"&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;strict
&lt;/span&gt;&lt;span style="color: #800080"&gt;$server&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #800080"&gt;$root&lt;/span&gt;&lt;span style="color: #000000"&gt;.Arrays &lt;/span&gt;&lt;span style="color: #000000"&gt;|&lt;/span&gt;&lt;span style="color: #000000"&gt; Select&lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;Object &lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;first &lt;/span&gt;&lt;span style="color: #000000"&gt;1&lt;/span&gt;&lt;span style="color: #000000"&gt;
&lt;/span&gt;&lt;span style="color: #800080"&gt;$publicNetwork&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #800080"&gt;$server&lt;/span&gt;&lt;span style="color: #000000"&gt;.NetworkConfiguration.Networks &lt;/span&gt;&lt;span style="color: #000000"&gt;|&lt;/span&gt;&lt;span style="color: #000000"&gt; Where&lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;Object { &lt;/span&gt;&lt;span style="color: #800080"&gt;$_&lt;/span&gt;&lt;span style="color: #000000"&gt;.NetworkType &lt;/span&gt;&lt;span style="color: #008080"&gt;-eq&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;3&lt;/span&gt;&lt;span style="color: #000000"&gt; }
&lt;/span&gt;&lt;span style="color: #800080"&gt;$ipSecSite2SiteNetworks&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #800080"&gt;$server&lt;/span&gt;&lt;span style="color: #000000"&gt;.NetworkConfiguration.Networks &lt;/span&gt;&lt;span style="color: #000000"&gt;|&lt;/span&gt;&lt;span style="color: #000000"&gt; Where&lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;Object { &lt;/span&gt;&lt;span style="color: #800080"&gt;$_&lt;/span&gt;&lt;span style="color: #000000"&gt;.NetworkConnectionType &lt;/span&gt;&lt;span style="color: #008080"&gt;-eq&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;4&lt;/span&gt;&lt;span style="color: #000000"&gt; }

&lt;/span&gt;&lt;span style="color: #800080"&gt;$ipSecSite2SiteNetworks&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #000000"&gt;|&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #0000ff"&gt;ForEach&lt;/span&gt;&lt;span style="color: #000000"&gt;-&lt;/span&gt;&lt;span style="color: #000000"&gt;Object { &lt;/span&gt;&lt;span style="color: #800080"&gt;$_&lt;/span&gt;&lt;span style="color: #000000"&gt;.VpnConfiguration.IPSecSettings.LocalServerAddress &lt;/span&gt;&lt;span style="color: #000000"&gt;=&lt;/span&gt;&lt;span style="color: #000000"&gt; &lt;/span&gt;&lt;span style="color: #800080"&gt;$newIP&lt;/span&gt;&lt;span style="color: #000000"&gt;; &lt;/span&gt;&lt;span style="color: #800080"&gt;$_&lt;/span&gt;&lt;span style="color: #000000"&gt;.VpnConfiguration.IPSecSettings.Save() }&lt;/span&gt;&lt;/pre&gt;
&lt;p&gt;The&amp;nbsp;next step will be to integrate this script to an application that detects changes to IP address of certain network interfaces&amp;nbsp;â€“ we use &lt;a href="http://www.directupdate.net/"&gt;DirectUpdate&lt;/a&gt; to&amp;nbsp;keep our &lt;a href="http://www.dyndns.com/"&gt;dyndns.org domains&lt;/a&gt;&amp;nbsp;current. But any other tool&amp;nbsp;like the free &lt;a href="http://www.dyndns.com/support/clients/windows.html"&gt;DynDNS Updater&lt;/a&gt; that is able to spawn a process when a new IP is detected will certainly do.&lt;/p&gt;&lt;pre&gt;C:\WINDOWS\system32\WindowsPowerShell\v1.0\powershell.exe -noprofile -command C:\Tools\Update-IsaServerIPSecPublicIp.ps1 &amp;lt;new IP address&amp;gt;&lt;/pre&gt;
&lt;p&gt;If you didn't use PowerShell until now, take a look at &lt;a href="http://www.hanselman.com/blog/" rel="acquaintance"&gt;Scott Hanselman&lt;/a&gt;'s most recent &lt;a href="http://www.dnrtv.com/default.aspx?showID=82"&gt;dnrTV webcast&lt;/a&gt;.&amp;nbsp;Scott has&amp;nbsp;recorded&amp;nbsp;a really&amp;nbsp;nice piece where he starts downloading&amp;nbsp;the PowerShell&amp;nbsp;bits and walks you though the basic concepts and some more interesting details.&lt;/p&gt;</Content>
      <Created>2007-09-16T23:50:46.863875+02:00</Created>
      <Modified>2007-09-16T23:50:46.863875+02:00</Modified>
      <EntryId>7d038eda-eb8a-4aa2-af34-2b5c3ecf0f92</EntryId>
      <Description />
      <Title>Updating ISA Server's Local IPSec Endpoint Address for Dial-Up Site-To-Site VPNs Through PowerShell</Title>
      <Categories>Networking;PowerShell</Categories>
      <Author>agross</Author>
      <IsPublic>true</IsPublic>
      <Syndicated>true</Syndicated>
      <ShowOnFrontPage>true</ShowOnFrontPage>
      <AllowComments>true</AllowComments>
      <Attachments />
      <Crossposts />
      <Latitude xsi:nil="true" />
      <Longitude xsi:nil="true" />
    </Entry>
  </Entries>
</DayEntry>