<?xml version="1.0" encoding="utf-8"?>
<DayEntry xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:newtelligence-com:dasblog:runtime:data">
  <Date>2007-03-01T01:00:00.0000000+01:00</Date>
  <Entries>
    <Entry>
      <Content>&lt;p&gt;The &lt;a href="http://en.wikipedia.org/wiki/WPAD" rel="previewlink"&gt;Web Proxy Auto Discovery Protocol&lt;/a&gt;, WPAD for short, simply does what its name implies. An application connecting to the internet may search the local network to find information about proxies and rules which proxy to use when connecting to specific (i.e. local or remote) servers. WPAD&amp;nbsp;leverages a JavaScript file called &lt;strong&gt;wpad.dat&lt;/strong&gt; that is located on a WPAD server. The file itself is retrieved using &lt;acronym title="Hypertext Transfer Protocol"&gt;HTTP&lt;/acronym&gt;. WPAD has been implemented by Netscape in 1996 has not changed much since then.&lt;/p&gt; &lt;h3&gt;Publishing WPAD Information&lt;/h3&gt; &lt;p&gt;Basically there are two ways for an application to detect the &lt;acronym title="Uniform Resource Locator"&gt;URL&lt;/acronym&gt; to the WPAD server:&lt;/p&gt; &lt;ul&gt; &lt;li&gt;There is a &lt;a href="http://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" rel="previewlink"&gt;DHCP&lt;/a&gt; option that tells DHCP clients where &lt;strong&gt;wpad.dat&lt;/strong&gt; can be found on a network.&amp;nbsp;By virtue of DHCP this information is only available to DHCP clients. The DHCP option 252 can be used to return an URL to the &lt;strong&gt;wpad.dat&lt;/strong&gt; file, e.g. &lt;a href="http://wpad/wpad.dat"&gt;http://wpad/wpad.dat&lt;/a&gt;. Note that URLs specifying non-standard ports are also possible: &lt;a href="http://wpad:79/wpad.dat"&gt;http://wpad:79/wpad.dat&lt;/a&gt;.  &lt;li&gt;The other&amp;nbsp;way to retrieve the&amp;nbsp;&lt;strong&gt;wpad.dat&lt;/strong&gt; script is to do a DNS lookup for a host named WPAD and do a HTTP GET for /wpad.dat on this host. The DNS option, however, provides less information to the client application because it only specifies the server and has no way of&amp;nbsp;transmitting information about the HTTP port to the client.&lt;/li&gt;&lt;/ul&gt; &lt;h3&gt;Different Clients&lt;/h3&gt; &lt;p&gt;Although WPAD has &lt;a href="http://www.ietf.org/proceedings/99nov/I-D/draft-ietf-wrec-wpad-01.txt" rel="previewlink"&gt;not become an internet standard&lt;/a&gt; yet, both Internet Explorer and Firefox try to acquire the WPAD script if you configure automatic proxy configuration, but in a slightly different way. Internet Explorer prefers DHCP information over DNS whereas Firefox &lt;em&gt;only&lt;/em&gt; uses DNS.&lt;/p&gt; &lt;p&gt;Also, Window's&amp;nbsp;built-in &lt;a href="http://msdn2.microsoft.com/en-us/library/aa384240.aspx" rel="previewlink"&gt;WinHTTP Web Proxy Auto-Discovery Service&lt;/a&gt;&amp;nbsp;uses either DHCP or DNS to obtain WPAD information.&lt;/p&gt; &lt;h3&gt;Possible Problems&lt;/h3&gt; &lt;p&gt;Typically, the &lt;strong&gt;wpad.dat&lt;/strong&gt; script is generated and served served by firewalls and proxy servers like &lt;a href="http://www.microsoft.com/isaserver/" rel="previewlink"&gt;Microsoft ISA Server&lt;/a&gt; based on the network configuration (you could also write your own custom &lt;a href="http://en.wikipedia.org/wiki/Proxy_auto-config" rel="previewlink"&gt;WPAD script&lt;/a&gt;). The WPAD HTTP server, like any other HTTP server, &amp;nbsp;listens on port 80 for incoming requests. Because this would lead to conflicting ports if you're running another ("workhorse") HTTP server on port 80 of the firewall/proxy, WPAD-enabled firewalls and proxies typically let you choose an alternative port to listen for WPAD requests. All you need to do is to change the DHCP URL accordingly.&lt;/p&gt; &lt;p&gt;But what about the DNS case? As stated above, DNS does not carry port information. A successful DNS lookup for the WPAD host is all to justify a subsequent HTTP request to the server &lt;em&gt;on port 80&lt;/em&gt;. But there's not the WPAD server answering, it's the workhorse HTTP server not knowing about a file called &lt;strong&gt;wpad.dat&lt;/strong&gt;: &lt;a href="http://en.wikipedia.org/wiki/404_error" rel="previewlink"&gt;HTTP/404&lt;/a&gt;. Bummer.&lt;/p&gt; &lt;h3&gt;Solutions&lt;/h3&gt; &lt;p&gt;Of course, you could copy &lt;strong&gt;wpad.dat&lt;/strong&gt; to your "real" workhorse web server. But if the firewall/proxy configuration changes, you would need to copy the file over and over&amp;nbsp;again. Certainly nothing&amp;nbsp;a good network administrator strives for.&lt;/p&gt; &lt;ol&gt; &lt;li&gt;One solution I tried was enabling URL rewriting on the workhorse web server and &lt;a href="http://en.wikipedia.org/wiki/URL_redirection" rel="previewlink"&gt;redirect requests&lt;/a&gt; for /wpad.dat to the WPAD HTTP server running on the alternative port 79. Although Firefox understands HTTP redirects, they were ignored, presumably for security reasons. &lt;strong&gt;Does not work.&lt;/strong&gt;  &lt;li&gt;A&amp;nbsp;&lt;a href="http://blogs.msdn.com/david.wang/archive/2005/08/01/HOWTO_Common_URL_Redirection_Techniques_for_IIS_Summary.aspx" rel="previewlink"&gt;proxiing redirect&lt;/a&gt; on the server would come in handy, but I&amp;nbsp;couldn't find free &lt;acronym title="Internet Server Application Programming Interface"&gt;&lt;a href="http://en.wikipedia.org/wiki/ISAPI" rel="previewlink"&gt;ISAPI&lt;/a&gt;&lt;/acronym&gt; components doing this. If you like to spend some money, &lt;a href="http://www.isapirewrite.com/" rel="previewlink"&gt;ISAPI_Rewrite&lt;/a&gt; may be your choice as it has the&amp;nbsp;&lt;code&gt;&lt;a title="previewlink" href="http://www.isapirewrite.com/docs/#RewriteProxy"&gt;RewriteProxy&lt;/a&gt;&lt;/code&gt; directive. &lt;strong&gt;Works, if you are willing to spend money.&lt;/strong&gt;&lt;/li&gt;&lt;/ol&gt; &lt;p&gt;Wanting a &lt;strong&gt;free solution&lt;/strong&gt;, I&amp;nbsp;a proxy web site on the workhorse &lt;acronym title="Internet Information Services"&gt;IIS&lt;/acronym&gt; with an ASP.NET &lt;a href="http://msdn2.microsoft.com/en-us/library/system.web.ihttphandler.aspx" rel="previewlink"&gt;IHttpHandler&lt;/a&gt;.&lt;/p&gt; &lt;ol&gt; &lt;li&gt;Set up your WPAD configuration so that the WPAD HTTP server listens on a port that is not used by other applications.  &lt;li&gt;Create a&amp;nbsp;&lt;a href="http://en.wikipedia.org/wiki/Domain_name_system#Types_of_DNS_records" rel="previewlink"&gt;host (A) DNS entry&lt;/a&gt; for the WPAD host, pointing to the IP address of your proxy/firewall that also hosts IIS.  &lt;li&gt;Set up &lt;a href="http://www.microsoft.com/technet/isa/2004/help/SRSP1_H_Create252.mspx" rel="previewlink"&gt;option 252 on your DHCP server&lt;/a&gt; giving it a value of &lt;a href="http://wpad/wpad.dat"&gt;http://wpad/wpad.dat&lt;/a&gt;. The port can be omitted as we're proxiing requests to the real WPAD server.  &lt;li&gt;Create a new IIS web site on port 80, specify&amp;nbsp;&lt;a href="http://support.microsoft.com/kb/190008" rel="previewlink"&gt;host headers&lt;/a&gt; wpad and wpad.your-domain. The web site should run&amp;nbsp;as an ASP.NET 2.0 application.  &lt;li&gt;&lt;a href="http://www.microsoft.com/technet/prodtechnol/WindowsServer2003/Library/IIS/4c840252-fab7-427e-a197-7facb6649106.mspx?mfr=true" rel="previewlink"&gt;Add a script mapping&lt;/a&gt;&amp;nbsp;for &lt;strong&gt;.dat&lt;/strong&gt; files&amp;nbsp;so that they are processed by &lt;strong&gt;%windir%\microsoft.net\framework\v2.0.50727\aspnet_isapi.dll&lt;/strong&gt;. Be sure to uncheck the "Check that file exists" option.  &lt;li&gt;Put &lt;a title="Download WPAD Proxy" href="http://www.it99.org/axl/download/WPAD-Proxy-1.0.zip"&gt;these files&lt;/a&gt; in the web site's root folder, allow NTFS read access for IUSR_&amp;lt;Machine Name&amp;gt; and NETWORK SERVICE.  &lt;li&gt;Open &lt;strong&gt;web.config&lt;/strong&gt; with a text editor and adjust the URL to the real WPAD server in the only key of /configuration/appSettings.  &lt;li&gt;Test your WPAD configuration with &lt;a href="http://www.gnu.org/software/wget/index.html#downloading" rel="previewlink"&gt;wget&lt;/a&gt;:&lt;pre&gt;rem Test the real WPAD server, this is what the proxy web site uses.
wget http://wpad:&amp;lt;alternative port&amp;gt;/wpad.dat
rem Test the proxy WPAD server, this is what clients use.
wget http://wpad/wpad.dat
&lt;/pre&gt;
&lt;li&gt;Test with Internet Explorer, Firefox and other clients. Take a look at the IIS log files if requests were served with HTTP status code 200.&lt;/li&gt;&lt;/ol&gt;
&lt;p class="now-playing"&gt;Now Playing [&lt;a title="Find out about Now Playing" href="http://www.it99.org/axl/Projects/NowPlaying/" rel="previewlink"&gt;?&lt;/a&gt;]: Fujiya &amp;amp; Miyagi – Cassettesingle&lt;/p&gt;</Content>
      <Created>2007-03-01T18:01:16.5287404+01:00</Created>
      <Modified>2007-03-03T20:48:33.3428750+01:00</Modified>
      <EntryId>a416412f-928f-4177-a1ee-9e01a3cbca1e</EntryId>
      <Title>The Web Proxy Auto-Discovery Protocol (WPAD)</Title>
      <Categories>ASP.NET;Networking</Categories>
      <Author>agross</Author>
      <IsPublic>true</IsPublic>
      <Syndicated>true</Syndicated>
      <ShowOnFrontPage>true</ShowOnFrontPage>
      <AllowComments>true</AllowComments>
      <Attachments />
      <Crossposts />
    </Entry>
  </Entries>
</DayEntry>